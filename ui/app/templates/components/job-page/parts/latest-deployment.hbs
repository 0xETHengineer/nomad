{{!-- TODO: probably just use the existing panel.hbs / panel.js for this. --}}
<div class="boxed-section job-status-panel {{if this.job.latestDeployment.isRunning "is-info"}}" data-test-active-deployment>
  <div class="boxed-section-head">
    <div class="boxed-section-row">
      {{if this.job.latestDeployment.isRunning "Active" "Latest"}} Deployment
      <span class="badge is-white {{if this.job.latestDeployment.isRunning "is-subtle"}} bumper-left" data-test-active-deployment-stat="id">{{this.job.latestDeployment.shortId}}</span>
      {{#if this.job.latestDeployment.version.submitTime}}
        <span class="pull-right submit-time tooltip" data-test-active-deployment-stat="submit-time" aria-label="{{format-ts this.job.latestDeployment.version.submitTime}}">
          {{moment-from-now this.job.latestDeployment.version.submitTime}}
        </span>
      {{/if}}
    </div>
    <div class="boxed-section-row">
      <span class="tag is-outlined {{this.job.latestDeployment.statusClass}}" data-test-deployment-status="{{this.job.latestDeployment.statusClass}}">
        {{this.job.latestDeployment.status}}
      </span>
      <div class="pull-right">
        {{#if this.job.latestDeployment.isRunning}}
          <TwoStepButton
            data-test-fail
            @classes={{hash
              idleButton="is-danger"
              confirmationMessage="inherit-color"
              confirmButton="is-danger"}}
            @idleText="Fail Deployment"
            @cancelText="Cancel"
            @confirmText="Yes, Fail Deployment"
            @confirmationMessage="Are you sure?"
            @inlineText={{true}}
            @awaitingConfirmation={{this.fail.isRunning}}
            @disabled={{this.fail.isRunning}}
            @onConfirm={{perform this.fail}} />
        {{/if}}
        {{#if this.job.latestDeployment.requiresPromotion}}
          <button
            data-test-promote-canary
            type="button"
            class="button is-warning is-small {{if this.promote.isRunning "is-loading"}}"
            disabled={{this.promote.isRunning}}
            onclick={{perform this.promote}}>Promote Canary</button>
        {{/if}}
      </div>
    </div>
  </div>
  <div class="boxed-section-body with-foot">
    <header>
      Lenses:
      <Hds::ButtonSet>
        <Hds::Button @text="Status" @color="{{if (eq this.lens "status") "primary" "secondary"}}" {{on "click" (action (mut this.lens) "status") }}/>
        <Hds::Button @text="Running Health" @color="{{if (eq this.lens "health") "primary" "secondary"}}" {{on "click" (action (mut this.lens) "health") }} />
        <Hds::Button @text="Version" @color="{{if (eq this.lens "version") "primary" "secondary"}}" {{on "click" (action (mut this.lens) "version") }} />
      </Hds::ButtonSet>

    </header>
    {{#if this.oldVersionAllocBlockIDs.length}}
      Previous Allocations: {{#if this.oldVersionAllocBlocks.running}}{{this.oldVersionAllocBlocks.running.length}} running{{/if}}
      <JobStatus::AllocationStatusRow @allocBlocks={{this.oldVersionAllocBlocks}} @versioned={{eq this.lens "version"}} />
    {{/if}}
    {{log "OLDIE" this.oldVersionAllocBlocks}}

    {{#if (eq this.lens "health")}}
      New allocations: {{this.newVersionAllocBlocks.healthy.length}}/{{this.job.latestDeployment.desiredTotal}} healthy
    {{else}}
      New allocations: {{this.newVersionAllocBlocks.running.length}}/{{this.job.latestDeployment.desiredTotal}} running
    {{/if}}
    <JobStatus::AllocationStatusRow @allocBlocks={{this.newVersionAllocBlocks}} />

    <footer>
      <legend>
        {{#if (eq this.lens "health")}}
        <span class="legend-item healthy">
          <span class="represented-allocation healthy"></span>
          {{this.newVersionAllocBlocks.healthy.length}} Healthy
        </span>
        <span class="legend-item unhealthy">
          <span class="represented-allocation unhealthy"></span>
          {{this.newVersionAllocBlocks.unhealthy.length}} Unhealthy
        </span>
          {{else}}
          {{#each this.allocTypes as |type|}}
            <span class="legend-item {{if (eq (get (get this.newVersionAllocBlocks type.label) "length") 0) "faded"}}">
              <span class="represented-allocation {{type.label}}"></span>
              {{get (get this.newVersionAllocBlocks type.label) "length"}} {{capitalize type.label}}
            </span>
          {{/each}}
        {{/if}}
      </legend>
    </footer>

    <hr />Only included for posterity:

    <JobDeploymentDetails @deployment={{this.job.latestDeployment}} as |d|>
      <d.metrics />
      {{#if this.isShowingDeploymentDetails}}
        <d.taskGroups />
        <d.allocations />
      {{/if}}
    </JobDeploymentDetails>
  </div>
  <div class="boxed-section-foot">
    <a class="pull-right" {{action (toggle "isShowingDeploymentDetails" this)}} href="#" data-test-deployment-toggle-details>
      {{if this.isShowingDeploymentDetails "Hide" "Show"}} deployment task groups and allocations
    </a>
  </div>
</div>
